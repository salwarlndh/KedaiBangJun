{% extends 'homepage/layout.html' %}
{% block title %}
  Cart
{% endblock %}
{% block content %}
<div class="d-flex cart justify-content-center p-5 mx-5 my-5">
  <div style="width: 75rem;">
      <h3 class="text-center border-bottom pb-3">Shopping Cart</h3>
      <div class="text-end">
          <h4><span id="cart_quantity">{{ cart|length }}</span> Items</h4>
      </div>
      <table class="table table-bordered table-hover text-center mt-4" id="cart-table">
          <thead class="table-light">
              <tr>
                  <th>Name Product</th>
                  <th>Quantity</th>
                  <th>Price</th>
                  <th>Total</th>
              </tr>
          </thead>
          <tbody>
              {% if cart_products %}
              {% for product in cart_products %}
              <tr class="cart-item" data-id="{{ product.id }}">
                  <td>{{ product.name }}</td>
                  <td>
                      <select class="form-select form-select sm quantity-select" aria-label="Default select example">
                          <option value="1" {% if product.quantity == 1 %}selected{% endif %}>1</option>
                          <option value="2" {% if product.quantity == 2 %}selected{% endif %}>2</option>
                          <option value="3" {% if product.quantity == 3 %}selected{% endif %}>3</option>
                          <option value="4" {% if product.quantity == 4 %}selected{% endif %}>4</option>
                          <option value="5" {% if product.quantity == 5 %}selected{% endif %}>5</option>
                          <option value="6" {% if product.quantity == 6 %}selected{% endif %}>6</option>
                          <option value="7" {% if product.quantity == 7 %}selected{% endif %}>7</option>
                          <option value="8" {% if product.quantity == 8 %}selected{% endif %}>8</option>
                          <option value="9" {% if product.quantity == 9 %}selected{% endif %}>9</option>
                          <option value="10" {% if product.quantity == 10 %}selected{% endif %}>10</option>
                      </select>
                  </td>
                  <td>{{ product.price }}</td>
                  <td class="item-total">{{ product.price|floatformat:0 }}</td>
              </tr>
              {% endfor %}
              {% else %}
              <tr>
                  <td colspan="4">Belum Ada Isi Cart</td>
              </tr>
              {% endif %}
          </tbody>
      </table>
      <div class="text-end mt-3">
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#cartModal" id="view-cart-btn">
              View Cart Summary
          </button>
      </div>
  </div>
</div>


<!-- Modal -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="cartModalLabel">Cart Summary</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <table class="table table-bordered">
                  <thead>
                      <tr>
                          <th>Name Product</th>
                          <th>Quantity</th>
                          <th>Price</th>
                          <th>Total</th>
                      </tr>
                  </thead>
                  <tbody id="modal-cart-body">
                      <!-- Data will be populated here dynamically -->
                  </tbody>
              </table>
              <div class="d-flex justify-content-center">
                  <button class="btn btn-success Btncheckout" type="button" style="width: 10rem; font-weight: bold;" onclick="confirmCart()">Checkout</button>
              </div>
          </div>
      </div>
  </div>
</div>

<script>
  document.getElementById('view-cart-btn').addEventListener('click', function () {
    // Ambil elemen tabel utama
    const cartTable = document.getElementById('cart-table');
    const cartBody = cartTable.querySelector('tbody');
    const modalBody = document.getElementById('modal-cart-body');
    
    // Bersihkan modal body
    modalBody.innerHTML = '';

    // Iterasi melalui baris di tabel utama
    const rows = cartBody.querySelectorAll('tr');
    let grandTotal = 0; // Variabel untuk menghitung total keseluruhan
    rows.forEach(row => {
        // Skip row jika tidak ada data (contoh: baris "Belum Ada Isi Cart")
        if (row.querySelectorAll('td').length === 1) {
            return;
        }

        // Ambil data dari setiap kolom
        const name = row.cells[0].textContent.trim();
        const quantity = row.querySelector('.quantity-select').value;
        const price = parseFloat(row.cells[2].textContent.trim().replace(/[^0-9.-]+/g, '')); // Ambil angka saja dari string
        const total = quantity * price;

        // Tambahkan total ke grand total
        grandTotal += total;

        // Tambahkan data ke modal
        const modalRow = `
            <tr>
                <td>${name}</td>
                <td>${quantity}</td>
                <td>${price.toLocaleString('id-ID')}</td>
                <td>${total.toLocaleString('id-ID')}</td>
            </tr>
        `;
        modalBody.innerHTML += modalRow;
    });

    // Tambahkan baris untuk Grand Total di modal
    const grandTotalRow = `
        <tr>
            <td colspan="3"><strong>Total Harga</strong></td>
            <td><strong>${grandTotal.toLocaleString('id-ID')}</strong></td>
        </tr>
    `;
    modalBody.innerHTML += grandTotalRow;

    function updateItemTotal(row) {
      const price = parseFloat(row.querySelector('td:nth-child(3)').textContent.replace(/[^0-9.-]+/g, ''));
      const quantity = parseInt(row.querySelector('.quantity-select').value, 10);
      const total = price * quantity;
      
      // Update total column
      row.querySelector('.item-total').textContent = total.toLocaleString('id-ID');
    }
  
    // Event listener for quantity change
    document.querySelectorAll('.quantity-select').forEach(select => {
      select.addEventListener('change', function () {
        const row = this.closest('tr');
        updateItemTotal(row);
      });
    });
  
    // Initial calculation of total when the page loads
    document.querySelectorAll('.cart-item').forEach(row => {
      updateItemTotal(row);
    });
});

function confirmCart(){
  swal("Pemesanan Berhasil", "Silahkan Bayar Kekasir", "success").then(() => {
    clearCartFromLocalStorage();
    clearCartFromSessionStorage()

    window.location.href = '{% url 'homepage' %}';
  });
}

  window.onload = function() {
    // Cek apakah ada data keranjang di localStorage atau sessionStorage
    let cart = JSON.parse(localStorage.getItem('cart')) || JSON.parse(sessionStorage.getItem('cart'));
  
    if (cart) {
      // Jika data keranjang ada, tampilkan keranjang dan data produk
      console.log('Keranjang ada:', cart);
      // Tampilkan keranjang di halaman, misalnya dengan mengupdate DOM
      displayCart(cart); // Fungsi untuk menampilkan data keranjang di halaman
    } else {
      // Jika data keranjang kosong, tampilkan pesan bahwa keranjang kosong
      console.log('Keranjang kosong');
      // Tampilkan pesan bahwa keranjang kosong
      document.getElementById('cart-contents').innerHTML = 'Keranjang Anda kosong';
    }
  };
  
  // Fungsi untuk menampilkan data keranjang ke halaman
  function displayCart(cart) {
    // Asumsikan kita memiliki elemen dengan id 'cart-contents' untuk menampilkan isi keranjang
    const cartContents = document.getElementById('cart-contents');
    cartContents.innerHTML = ''; // Bersihkan dulu kontennya
  
    cart.forEach(item => {
      // Tampilkan item-item keranjang
      const itemElement = document.createElement('div');
      itemElement.innerHTML = `${item.name} - ${item.quantity} - ${item.price}`;
      cartContents.appendChild(itemElement);
    });
}

function saveCartToSessionStorage(cart) {
  sessionStorage.setItem('cart', JSON.stringify(cart));
}

// Menghapus dari sessionStorage
function clearCartFromSessionStorage() {
  sessionStorage.removeItem('cart');
}

function saveCartToLocalStorage(cart) {
  localStorage.setItem('cart', JSON.stringify(cart)); // Menyimpan data dalam format JSON
}

// Contoh menghapus data keranjang setelah checkout
function clearCartFromLocalStorage() {
  localStorage.removeItem('cart'); // Menghapus data keranjang dari localStorage
}

</script>

{% endblock %}
